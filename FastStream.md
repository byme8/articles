Доброго времени суток! 
Я бы сказал что для C# и .Net с выходом .Net Standart и dotnet core 3 наступает новая эпоха. Появляются новые API которые призваные ускорить как написание кода, так и его выполнение. И вот, розмышляя над тем, как еще можно ускорить сериализацию, стало интересно, что будет если реализовать ``` MemoryStream ``` при помощи ``` ArrayPool ``` вместо стандартной алокации.

Кому интересно посмотреть что из этого получилось прошу под кат.

<cut />

# nuget library

Немного о самой библиотеке. Как я уже говорил, основная задача библиотеки предоставить более производительную замену стандартному ``` MemoryStream ```.
Ее можно скачать через nuget. Она доступна под именем ``` FastStream ```.
Исходники лежат (тут)[https://github.com/byme8/faststream/].

# about array pool

Вернемся к реализации. Основное улучшение производительности достигнуто за счет ``` ArrayPool ``` . Так что же такое этот ``` ArrayPool ``` и зачем вообще он нужен? По сути это обычный класс, который не зависит рантайма или фрейворка. При его помощи можно добиться переиспользования памяти на уровне приложения, тем самым с економив время на алокацию и сборку мусора. В некоторых ситуациях может дать существеный прирост скорости выполнения. Это достигается за счет преалоцирования буферов, которые выдаються в "аредну" когда необходимы и возвращаються когда уже больше не нужны.

# examples/demo

Расмотрим пример использования класического ``` MemoryStream ```. Оно будет виглядить как-то так:

``` cs
var values = new double[] { // Откудато берем данные };

using (var memory = new MemoryStream())
using (var writer = new BinaryWriter(memory))
{
    writer.Write(values.Length);
    for (int i = 0; i < values.Length; i++)
    {
        writer.Write(values[i]);
    }

    // Что-то делаем с memory
}
```

Как видно из этого примера ``` MemoryStream ``` часто используется в связке с другими стримами, писателямии читателями. Поэтому было принято решение реализовать ``` Stream``` для того, чтобы была возможность просто взять и заменить класический ``` MemorySteam ``` на новый с минимальными изменениями. Называться он будет ``` FastMemoryWriter ```.

# benchmarks

Начать я решил из самого простого, а именно с ситуации когда нам нужно писать только байты. В таком случае нам не нужен ``` BinaryWriter ```. 
Бенчмарк имеет следующий вид:

``` cs
[MemoryDiagnoser]
public class FastStreamVSMemoryStream
{
    [Params(100, 100_000)]
    public int Size { get; set; }

    [Params(10, 100, 1000)]
    public int ItemCount { get; set; }


    [Benchmark]
    public void Bytes()
    {
        var data = new byte[this.Size];
        for (int j = 0; j < 10; j++)
        {
            using (var memory = new MemoryStream())
            {
                for (int i = 0; i < this.ItemCount; i++)
                {
                    memory.Write(data, 0, data.Length);
                }

                var bytes = memory.ToArray();
            }
        }
    }

    [Benchmark]
    public void FastBytes()
    {
        var data = new byte[this.Size];
        for (int j = 0; j < 10; j++)
        {
            using (var memory = new FastMemoryWriter())
            {
                for (int i = 0; i < this.ItemCount; i++)
                {
                    memory.Write(data, 0, data.Length);
                }

                var bytes = memory.ToArray();
            }
        }
    }
}
```

Результаты имеют следующий вид:

|    Method |   Size | ItemCount |             Mean |          Error |        StdDev |      Gen 0 |      Gen 1 |      Gen 2 |     Allocated |
|---------- |------- |---------- |-----------------:|---------------:|--------------:|-----------:|-----------:|-----------:|--------------:|
|     Bytes |    100 |        10 |         4.035 us |      0.0166 us |     0.0139 us |     7.0801 |          - |          - |      29.03 KB |
| FastBytes |    100 |        10 |         2.584 us |      0.0365 us |     0.0305 us |     2.6398 |          - |          - |      10.83 KB |
|     Bytes |    100 |       100 |        44.715 us |      0.3315 us |     0.3101 us |   101.9897 |          - |          - |     417.86 KB |
| FastBytes |    100 |       100 |        21.193 us |      0.2007 us |     0.1779 us |    24.0784 |          - |          - |      98.72 KB |
|     Bytes |    100 |      1000 |     1,307.406 us |     13.0773 us |    12.2325 us |   712.8906 |   712.8906 |   712.8906 |    3537.47 KB |
| FastBytes |    100 |      1000 |       623.582 us |     10.0411 us |     8.3848 us |   311.5234 |   311.5234 |   311.5234 |     977.63 KB |
|     Bytes | 100000 |        10 |     7,898.103 us |    156.2200 us |   197.5682 us |  8156.2500 |  8156.2500 |  8156.2500 |   40143.49 KB |
| FastBytes | 100000 |        10 |     2,313.145 us |     45.7079 us |    66.9981 us |  1984.3750 |  1980.4688 |  1980.4688 |    9871.03 KB |
|     Bytes | 100000 |       100 |   147,890.745 us |  1,273.3619 us | 1,128.8021 us |  9000.0000 |  9000.0000 |  9000.0000 |  346780.31 KB |
| FastBytes | 100000 |       100 |    78,934.645 us |    308.8992 us |   288.9445 us |  1428.5714 |  1428.5714 |  1428.5714 |   97754.87 KB |
|     Bytes | 100000 |      1000 | 1,807,966.262 us | 10,854.7535 us | 9,064.2108 us | 22000.0000 | 22000.0000 | 22000.0000 | 2975687.13 KB |
| FastBytes | 100000 |      1000 |   850,008.050 us |  3,997.9700 us | 3,544.0963 us |          - |          - |          - |  976661.12 KB |

На таблице заметно, что мы получаем прирост в скорости испольнения даже на остносительно небольших объемах данных. При записи 1000 байтов получается прирост в ~35%, а при больших количествах получаеться ~50%.
При этом используется заменто меньше памяти, что тоже приятно.


|                          Method | ItemCount |       Mean |     Error |    StdDev |   Gen 0 | Gen 1 | Gen 2 | Allocated |
|-------------------------------- |---------- |-----------:|----------:|----------:|--------:|------:|------:|----------:|
|     MemoryStreamAndBinaryWriter |        10 |   2.632 us | 0.0116 us | 0.0109 us |  1.4648 |     - |     - |   6.02 KB |
| FastMemoryWriterAndBinaryWriter |        10 |   2.411 us | 0.0347 us | 0.0341 us |  0.8011 |     - |     - |   3.28 KB |
|            OnlyFastMemoryWriter |        10 |   1.121 us | 0.0061 us | 0.0054 us |  0.4177 |     - |     - |   1.72 KB |
|     MemoryStreamAndBinaryWriter |       100 |  18.407 us | 0.2236 us | 0.1867 us |  6.9580 |     - |     - |  28.52 KB |
| FastMemoryWriterAndBinaryWriter |       100 |  14.175 us | 0.1982 us | 0.1757 us |  2.5024 |     - |     - |  10.31 KB |
|            OnlyFastMemoryWriter |       100 |   5.205 us | 0.0373 us | 0.0311 us |  2.1286 |     - |     - |   8.75 KB |
|     MemoryStreamAndBinaryWriter |      1000 | 166.776 us | 0.7487 us | 0.6637 us | 58.3496 |     - |     - | 239.53 KB |
| FastMemoryWriterAndBinaryWriter |      1000 | 127.801 us | 1.2563 us | 1.1751 us | 19.5313 |     - |     - |  80.63 KB |
|            OnlyFastMemoryWriter |      1000 |  49.242 us | 0.2441 us | 0.2284 us | 19.2261 |     - |     - |  79.06 KB |

